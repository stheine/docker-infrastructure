version: "3.7"

# Ports
#    25 postfix                smtp
#   993 dovecot                imap                          Freigabe in FritzBox
#  1499 unison                 unison/ rsync                 Freigabe in FritzBox
#  1883 mosquitto-websockets   mqtt
#  2342 photoprism             http://192.168.6.7:2342/
#  8008 portainer              http://192.168.6.7:8008/
#  8925 hivemq-mqtt-web-client http://192.168.6.7:8925/
#  9001 mosquitto-websockets   websockets
# 16095 uptime-kuma            http://192.168.6.7:16095/
# 26687 control-ui             http://192.168.6.7:26687/
# 31038 watchdog               http://192.168.6.7:31038/
# 45458 node-red               http://192.168.6.7:45458/
# 57699 proxy                  http://192.168.6.7:57699/
# 59080 nginx (http)           http://192.168.6.7:59080/     Freigabe in FritzBox
# 59443 nginx (https)          https://192.168.6.7:59443/    Freigabe in FritzBox
# 59154 gerbera-musik          http://192.168.6.7:59154/
# 59155 gerbera-kinder-filme   http://192.168.6.7:59155/
# 59156 gerbera-kinder-cds     http://192.168.6.7:59156/
# 59157 gerbera-fotos          http://192.168.6.7:59157/
# 59158 gerbera-filme          http://192.168.6.7:59158/
# 59159 gerbera-video          http://192.168.6.7:59159/

volumes:
  fritz:
    driver: local
    driver_opts:
      type: none
      device: /share/linux/data/fritz
      o: bind

  fronius:
    driver: local
    driver_opts:
      type: none
      device: /share/linux/data/fronius
      o: bind

  gerbera-filme:
    driver: local
    driver_opts:
      type: none
      device: /share/linux/data/gerberaFilme
      o: bind

  gerbera-fotos:
    driver: local
    driver_opts:
      type: none
      device: /share/linux/data/gerberaFotos
      o: bind

  gerbera-kinder-cds:
    driver: local
    driver_opts:
      type: none
      device: /share/linux/data/gerberaKinderCDs
      o: bind

  gerbera-kinder-filme:
    driver: local
    driver_opts:
      type: none
      device: /share/linux/data/gerberaKinderFilme
      o: bind

  gerbera-musik:
    driver: local
    driver_opts:
      type: none
      device: /share/linux/data/gerberaMusik
      o: bind

  gerbera-video:
    driver: local
    driver_opts:
      type: none
      device: /share/linux/data/gerberaVideo
      o: bind

  homer:
    driver: local
    driver_opts:
      type: none
      device: /share/linux/data/homer
      o: bind

  jalousie:
    driver: local
    driver_opts:
      type: none
      device: /share/linux/data/jalousie
      o: bind

  letsencrypt:
    driver: local
    driver_opts:
      type: none
      device: /share/linux/data/letsencrypt
      o: bind

  letsencrypt_www:
    driver: local
    driver_opts:
      type: none
      device: /share/linux/data/letsencrypt_www
      o: bind

  media_filme:
    driver: local
    driver_opts:
      type: none
      device: /share/Filme
      o: bind

  media_fotos:
    driver: local
    driver_opts:
      type: none
      device: /share/Fotos
      o: bind

  media_kinder-cds:
    driver: local
    driver_opts:
      type: none
      device: /share/KinderCDs
      o: bind

  media_kinder-filme:
    driver: local
    driver_opts:
      type: none
      device: /share/KinderFilme
      o: bind

  media_musik:
    driver: local
    driver_opts:
      type: none
      device: /share/Musik
      o: bind

  media_video:
    driver: local
    driver_opts:
      type: none
      device: /share/Sat-Rekorder
      o: bind

  mediawiki-database:
    driver: local
    driver_opts:
      type: none
      device: /share/linux/data/mediawiki-database
      o: bind

  mediawiki-database-backup:
    driver: local
    driver_opts:
      type: none
      device: /share/linux/data/mediawiki-database-backup
      o: bind

  mediawiki-images:
    driver: local
    driver_opts:
      type: none
      device: /share/linux/data/mediawiki-images
      o: bind

  mosquitto-data:
    driver: local
    driver_opts:
      type: none
      device: /share/linux/data/mosquitto/data
      o: bind

  mosquitto-log:
    driver: local
    driver_opts:
      type: none
      device: /share/linux/data/mosquitto/log
      o: bind

  node-red:
    driver: local
    driver_opts:
      type: none
      device: /share/linux/data/node-red
      o: bind

  photoprism:
    driver: local
    driver_opts:
      type: none
      device: /share/linux/data/photoprism
      o: bind

  photoprism-database:
    driver: local
    driver_opts:
      type: none
      device: /share/linux/data/photoprism-database
      o: bind

  portainer:
    driver: local
    driver_opts:
      type: none
      device: /share/linux/data/portainer
      o: bind

  postfix_creds:
    driver: local
    driver_opts:
      type: none
      device: /share/linux/data/postfix_creds
      o: bind

  sshd_certs:
    driver: local
    driver_opts:
      type: none
      device: /share/linux/data/sshd_certs
      o: bind

  strom:
    driver: local
    driver_opts:
      type: none
      device: /share/linux/data/strom
      o: bind

  unison:
    driver: local
    driver_opts:
      type: none
      device: /share/linux/data/unison
      o: bind

  uptime-kuma:
    driver: local
    driver_opts:
      type: none
      device: /share/linux/data/uptime-kuma
      o: bind

  vaultwarden:
    driver: local
    driver_opts:
      type: none
      device: /share/linux/data/vaultwarden-data
      o: bind

  vito:
    driver: local
    driver_opts:
      type: none
      device: /share/linux/data/vito
      o: bind

  vmail:
    driver: local
    driver_opts:
      type: none
      device: /share/linux/data/vmail
      o: bind

  wasser:
    driver: local
    driver_opts:
      type: none
      device: /share/linux/data/wasser
      o: bind

  wetter:
    driver: local
    driver_opts:
      type: none
      device: /share/linux/data/wetter
      o: bind

  www:
    driver: local
    driver_opts:
      type: none
      device: /share/linux/data/www
      o: bind

  www_auth:
    driver: local
    driver_opts:
      type: none
      device: /share/linux/data/www_auth
      o: bind

# networks:
#   bridge:
#     driver: bridge

services:
  apache2:
    restart: always
    build: apache2
    hostname: qnap-apache2
    volumes:
      - fritz:/var/fritz
      - fronius:/var/fronius
      - jalousie:/var/jalousie
      - strom:/var/strom
      - vito:/var/vito
      - wasser:/var/wasser
      - www:/var/www
      - www_auth:/var/www_auth
      - ./apache2/httpd.conf:/usr/local/apache2/conf/httpd.conf:ro
    # healthcheck:
    #   test: /usr/bin/wget --quiet --output-file=/dev/null http://localhost/favicon.png

  certbot:
    restart: always
    build: certbot
    hostname: qnap-certbot
    volumes:
      - ./certbot/renew.sh:/renew.sh:ro
      - letsencrypt:/etc/letsencrypt:nocopy
      - letsencrypt_www:/var/letsencrypt

  control-ui:
    restart: always
    build: control-ui
    hostname: qnap-control-ui
    ports:
      - 26687:26687
    volumes:
      - ./control-ui/app:/app
      # - wetter:/var/wetter

  delete-video:
    restart: always
    build: delete-video
    hostname: qnap-delete-video
    volumes:
      - /share/CACHEDEV1_DATA/Sat-Rekorder:/video
      - ./delete-video/app:/app

  dovecot:
    restart: always
    build: dovecot
    hostname: qnap-dovecot
    ports:
      - 993:993
    volumes:
      - letsencrypt:/usr/local/etc/letsencrypt:nocopy
      - vmail:/home/vmail:nocopy

  fritz:
    restart: always
    build: fritz
    hostname: qnap-fritz
    volumes:
      - ./fritz/app:/app
      - fritz:/var/fritz

  fronius-battery:
    restart: always
    build: fronius-battery
    hostname: qnap-fronius-battery
    volumes:
      - ./fronius-battery/app:/app
      - fronius:/var/fronius

# Note: 'network_mode: host' is required for the upnp server for multicast traffic
#       to detect the upnp server.
  gerbera-filme:
    restart: always
    build: gerbera
    hostname: qnap-filme
    network_mode: host
    environment:
      - CONFIG=59158-filme
    volumes:
      - ./gerbera/config:/etc/gerbera/config
      - media_filme:/media:ro
      - gerbera-filme:/gerbera_home

  gerbera-fotos:
    restart: always
    build: gerbera
    hostname: qnap-fotos
    network_mode: host
    environment:
      - CONFIG=59157-fotos
    volumes:
      - ./gerbera/config:/etc/gerbera/config
      - media_fotos:/media:ro
      - gerbera-fotos:/gerbera_home

  gerbera-kinder-filme:
    restart: always
    build: gerbera
    hostname: qnap-kinder-filme
    network_mode: host
    environment:
      - CONFIG=59155-kinder-filme
    volumes:
      - ./gerbera/config:/etc/gerbera/config
      - media_kinder-filme:/media:ro
      - gerbera-kinder-filme:/gerbera_home

  gerbera-kinder-cds:
    restart: always
    build: gerbera
    hostname: qnap-kinder-cds
    network_mode: host
    environment:
      - CONFIG=59156-kinder-cds
    volumes:
      - ./gerbera/config:/etc/gerbera/config
      - media_kinder-cds:/media:ro
      - gerbera-kinder-cds:/gerbera_home

  gerbera-musik:
    restart: always
    build: gerbera
    hostname: qnap-gerbera-musik
    network_mode: host
    environment:
      - CONFIG=59154-musik
#      - EXTRA_PARAMETERS=--debug
    volumes:
      - ./gerbera/config:/etc/gerbera/config
      - media_musik:/media:ro
      - gerbera-musik:/gerbera_home

  gerbera-video:
    restart: always
    build: gerbera
    hostname: qnap-gerbera-video
    network_mode: host
    environment:
      - CONFIG=59159-video
    volumes:
      - ./gerbera/config:/etc/gerbera/config
      - media_video:/media:ro
      - gerbera-video:/gerbera_home

  hivemq-mqtt-web-client:
    restart: always
    build: hivemq-mqtt-web-client
    hostname: qnap-hivemq-mqtt-web-client
    ports:
      - 8925:80
    volumes:
      - ./hivemq-mqtt-web-client/nginx.conf:/etc/nginx/nginx.conf:ro

  homer:
    restart: always
    image: b4bz/homer:latest
    hostname: qnap-homer
    volumes:
      - homer:/www/assets

  mediawiki:
    restart: always
    build: mediawiki
    depends_on:
      - mediawiki-database
    volumes:
      - mediawiki-images:/var/www/html/images
      - ./mediawiki/LocalSettings.php:/var/www/html/LocalSettings.php:ro
      - ./mediawiki/php.ini:/usr/local/etc/php/php.ini:ro

  mediawiki-database:
    restart: always
    image: yobasystems/alpine-mariadb:armhf
    environment:
      # @see https://phabricator.wikimedia.org/source/mediawiki/browse/master/includes/DefaultSettings.php
      MYSQL_DATABASE: my_wiki
      MYSQL_USER: wikiuser
      MYSQL_PASSWORD: example
      MYSQL_RANDOM_ROOT_PASSWORD: "yes"
    volumes:
      - mediawiki-database:/var/lib/mysql
      - mediawiki-database-backup:/database-restore

  mediawiki-database-backup:
    restart: always
    build: mediawiki-database-backup
    volumes:
      - mediawiki-database-backup:/backup
      - mediawiki-images:/mediawiki-images
      - ./mediawiki-database-backup/automysqlbackup.conf:/etc/default/automysqlbackup:ro
    depends_on:
      - mediawiki-database

  mosquitto:
    restart: always
    image: eclipse-mosquitto:latest
    hostname: qnap-mosquitto
    ports:
      - 1883:1883
      - 9001:9001
    volumes:
      - mosquitto-data:/mosquitto/data
      - mosquitto-log:/mosquitto/log
      - ./mosquitto/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro

  mqtt2rrd:
    restart: always
    build: mqtt2rrd
    hostname: qnap-mqtt2rrd
    volumes:
      - ./mqtt2rrd/app:/app
      - fritz:/var/fritz
      - fronius:/var/fronius
      - jalousie:/var/jalousie
      - strom:/var/strom
      - vito:/var/vito
      - wasser:/var/wasser
      - www:/var/www

  mqtt-strom:
    restart: always
    build: mqtt-strom
    hostname: qnap-mqtt-strom
    volumes:
      - ./mqtt-strom/app:/app
      - strom:/var/strom

  mqtt-vito:
    restart: always
    build: mqtt-vito
    hostname: qnap-mqtt-vito
    volumes:
      - ./mqtt-vito/app:/app
      - vito:/var/vito

  mqtt-volumio:
    restart: always
    build: mqtt-volumio
    hostname: qnap-mqtt-volumio
    volumes:
      - ./mqtt-volumio/app:/app

  mqtt-wetter:
    restart: always
    build: mqtt-wetter
    hostname: qnap-mqtt-wetter
    volumes:
      - ./mqtt-wetter/app:/app
      - wetter:/var/wetter

  nginx:
    restart: always
    build: nginx
    hostname: qnap-nginx
    ports:
      - 59080:80
      - 59443:443
    volumes:
      - letsencrypt:/etc/letsencrypt
      - letsencrypt_www:/var/letsencrypt
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      # - apache2
      - homer
      - mediawiki
      - vaultwarden

  node-red:
    restart: always
    image: nodered/node-red
    hostname: qnap-node-red
    ports:
      - 45458:1880
    volumes:
      - node-red:/data

  photoprism:
    image: photoprism/photoprism:armv7
    restart: always
    depends_on:
      - photoprism-database
    security_opt:
      - seccomp:unconfined
      - apparmor:unconfined
    ports:
      - "2342:2342" # HTTP port (host:container)
    environment:
      PHOTOPRISM_ADMIN_PASSWORD: "insecure"          # YOUR INITIAL ADMIN PASSWORD (MINIMUM 8 CHARACTERS, USERNAME "admin")
      PHOTOPRISM_SITE_URL: "http://localhost:2342/"  # public server URL incl http:// or https:// and /path, :port is optional
      PHOTOPRISM_ORIGINALS_LIMIT: 5000               # file size limit for originals in MB (increase for high-res video)
      PHOTOPRISM_HTTP_COMPRESSION: "none"            # improves transfer speed and bandwidth utilization (none or gzip)
      PHOTOPRISM_WORKERS: 1                          # Limits the number of indexing workers to reduce system load
      PHOTOPRISM_LOG_LEVEL: "info"                   # log level: trace, debug, info, warning, error, fatal, or panic
      PHOTOPRISM_PUBLIC: "false"                     # no authentication required (disables password protection)
      PHOTOPRISM_READONLY: "false"                   # do not modify originals directory (reduced functionality)
      PHOTOPRISM_EXPERIMENTAL: "false"               # enables experimental features
      PHOTOPRISM_DISABLE_CHOWN: "false"              # disables storage permission updates on startup
      PHOTOPRISM_DISABLE_WEBDAV: "false"             # disables built-in WebDAV server
      PHOTOPRISM_DISABLE_SETTINGS: "false"           # disables Settings in Web UI
      PHOTOPRISM_DISABLE_TENSORFLOW: "false"         # disables all features depending on TensorFlow
      PHOTOPRISM_DISABLE_FACES: "true"               # disables facial recognition
      PHOTOPRISM_DISABLE_CLASSIFICATION: "false"     # disables image classification
      PHOTOPRISM_DISABLE_RAW: "true"                 # disables indexing and conversion of RAW files
      PHOTOPRISM_RAW_PRESETS: "false"                # enables applying user presets when converting RAW files (reduces performance)
      PHOTOPRISM_JPEG_QUALITY: 85                    # image quality, a higher value reduces compression (25-100)
      PHOTOPRISM_DETECT_NSFW: "false"                # flag photos as private that MAY be offensive
      PHOTOPRISM_UPLOAD_NSFW: "true"                 # allows uploads that MAY be offensive
      PHOTOPRISM_DATABASE_DRIVER: "mysql"            # use MariaDB 10.5+ or MySQL 8+ instead of SQLite for improved performance
      PHOTOPRISM_DATABASE_SERVER: "photoprism-database:3306"     # MariaDB or MySQL database server (hostname:port)
      PHOTOPRISM_DATABASE_NAME: "photoprism"         # MariaDB or MySQL database schema name
      PHOTOPRISM_DATABASE_USER: "photoprism"         # MariaDB or MySQL database user name
      PHOTOPRISM_DATABASE_PASSWORD: "insecure"       # MariaDB or MySQL database user password
      PHOTOPRISM_SITE_CAPTION: "AI-Powered Photos App"
      PHOTOPRISM_SITE_DESCRIPTION: ""                # meta site description
      PHOTOPRISM_SITE_AUTHOR: ""                     # meta site author
      ## Run/install on first startup (options: update, gpu, tensorflow, davfs, clean):
      # PHOTOPRISM_INIT: "update clean"
      PHOTOPRISM_UID: 1000
      PHOTOPRISM_GID: 1000
      PHOTOPRISM_UMASK: 0000
    working_dir: "/photoprism" # do not change or remove
    volumes:
      - media_fotos:/photoprism/originals:ro
      # - "~/Import:/photoprism/import"                  # *Optional* base folder from which files can be imported to originals
      - photoprism:/photoprism/storage

  photoprism-database:
    restart: always
    image: linuxserver/mariadb:latest
    security_opt:
      - seccomp:unconfined
      - apparmor:unconfined
    volumes:
      - photoprism-database:/config
    environment:
      MYSQL_ROOT_PASSWORD: insecure
      MYSQL_DATABASE: photoprism
      MYSQL_USER: photoprism
      MYSQL_PASSWORD: insecure

  portainer:
    restart: always
    image: portainer/portainer-ce
    hostname: qnap-portainer
    ports:
      - 8008:9000
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer:/data

  postfix:
    restart: always
    build: postfix
    hostname: qnap-postfix
    ports:
      - "25:25"
    volumes:
      - postfix_creds:/postfix_creds

  proxy:
    restart: always
    build: proxy
    hostname: qnap-proxy
    ports:
      - "57699:3128"
#    environment:
#      SQUID_CONFIG_FILE: /etc/squid/my-squid.conf
#    volumes:
#      - ./proxy/my-squid.conf:/etc/squid/my-squid.conf:ro

  snowflake-proxy:
    restart: always
    image: thetorproject/snowflake-proxy:latest
    network_mode: host

  unison:
    restart: always
    build: unison
    hostname: qnap-unison
    ports:
      - 1499:1499
    volumes:
      - media_musik:/var/musik:nocopy
      - sshd_certs:/var/sshd_certs:nocopy
      - unison:/root/.unison:nocopy

  uptime-kuma:
    restart: always
    # build: uptime-kuma
    image: louislam/uptime-kuma
    hostname: qnap-uptime-kuma
    ports:
      - 16095:3001
    volumes:
      - uptime-kuma:/app/data:nocopy

  vaultwarden:
    # https://github.com/dani-garcia/vaultwarden/wiki
    restart: always
    image: vaultwarden/server:1.29.0-alpine
    hostname: vaultwarden
    volumes:
      - vaultwarden:/data
    environment:
      - WEBSOCKET_ENABLED=true

  watchdog:
    restart: always
    build: watchdog
    hostname: qnap-watchdog
    volumes:
      - ./watchdog/app:/app
    ports:
      - 31038:31038
