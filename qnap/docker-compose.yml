version: "2.2"
# Remain on v2 for https://github.com/docker/compose/issues/4513

# Ports
#    25 postfix           smtp
#   993 dovecot           imap
#  8008 portainer         http://192.168.6.7:8008/
# 53000 grafana           http://192.168.6.7:53000/
# 59080 nginx             http://192.168.6.7:59080/
# 59443 nginx             https://192.168.6.7:59443/
# 59154 musik             http://192.168.6.7:59154/
# 59155 kinder-filme      http://192.168.6.7:59155/
# 59156 kinder-cds        http://192.168.6.7:59156/
# 59157 fotos             http://192.168.6.7:59157/
# 59158 filme             http://192.168.6.7:59158/

volumes:
  collectd-data:
    driver: local
    driver_opts:
      type: none
      device: /share/linux/data/collectd-data
      o: bind

  gerbera-filme:
    driver: local
    driver_opts:
      type: none
      device: /share/linux/data/gerberaFilme
      o: bind

  gerbera-fotos:
    driver: local
    driver_opts:
      type: none
      device: /share/linux/data/gerberaFotos
      o: bind

  gerbera-kinder-cds:
    driver: local
    driver_opts:
      type: none
      device: /share/linux/data/gerberaKinderCDs
      o: bind

  gerbera-kinder-filme:
    driver: local
    driver_opts:
      type: none
      device: /share/linux/data/gerberaKinderFilme
      o: bind

  gerbera-musik:
    driver: local
    driver_opts:
      type: none
      device: /share/linux/data/gerberaMusik
      o: bind

  grafana-storage:
    driver: local
    driver_opts:
      type: none
      device: /share/linux/data/grafana-storage
      o: bind

  influxdb:
    driver: local
    driver_opts:
      type: none
      device: /share/linux/data/influxdb
      o: bind

  jalousie:
    driver: local
    driver_opts:
      type: none
      device: /share/linux/data/jalousie
      o: bind

  jalousie_source:
    driver: local
    driver_opts:
      type: none
      device: /share/linux/docker/jalousie/jalousie/jalousie
      o: bind

  letsencrypt:
    driver: local
    driver_opts:
      type: none
      device: /share/linux/data/letsencrypt
      o: bind

  letsencrypt_www:
    driver: local
    driver_opts:
      type: none
      device: /share/linux/data/letsencrypt_www
      o: bind

  media_filme:
    driver: local
    driver_opts:
      type: none
      device: /share/Filme
      o: bind

  media_fotos:
    driver: local
    driver_opts:
      type: none
      device: /share/Fotos
      o: bind

  media_kinder-cds:
    driver: local
    driver_opts:
      type: none
      device: /share/KinderCDs
      o: bind

  media_kinder-filme:
    driver: local
    driver_opts:
      type: none
      device: /share/KinderFilme
      o: bind

  media_musik:
    driver: local
    driver_opts:
      type: none
      device: /share/Musik
      o: bind

  mediawiki-database:
    driver: local
    driver_opts:
      type: none
      device: /share/linux/data/mediawiki-database
      o: bind

  mediawiki-database-backup:
    driver: local
    driver_opts:
      type: none
      device: /share/linux/data/mediawiki-database-backup
      o: bind

  mediawiki-images:
    driver: local
    driver_opts:
      type: none
      device: /share/linux/data/mediawiki-images
      o: bind

  portainer:
    driver: local
    driver_opts:
      type: none
      device: /share/linux/data/portainer
      o: bind

  postfix_creds:
    driver: local
    driver_opts:
      type: none
      device: /share/linux/data/postfix_creds
      o: bind

  sshd_certs:
    driver: local
    driver_opts:
      type: none
      device: /share/linux/data/sshd_certs
      o: bind

  strom:
    driver: local
    driver_opts:
      type: none
      device: /share/linux/data/strom
      o: bind

  unison:
    driver: local
    driver_opts:
      type: none
      device: /share/linux/data/unison
      o: bind

  vito:
    driver: local
    driver_opts:
      type: none
      device: /share/linux/data/vito
      o: bind

  vmail:
    driver: local
    driver_opts:
      type: none
      device: /share/linux/data/vmail
      o: bind

  www:
    driver: local
    driver_opts:
      type: none
      device: /share/linux/data/www
      o: bind

  www_auth:
    driver: local
    driver_opts:
      type: none
      device: /share/linux/data/www_auth
      o: bind

# networks:
#   bridge:
#     driver: bridge

services:
  apache2:
    restart: unless-stopped
    build: apache2
    hostname: qnap-apache2
    volumes:
      - jalousie:/var/jalousie
      - strom:/var/strom
      - vito:/var/vito
      - www:/var/www
      - www_auth:/var/www_auth
    healthcheck:
      test: /usr/bin/wget --quiet --output-file=/dev/null http://localhost/favicon.png

  certbot:
    # Note: This container is started with /bin/true. This is just a dummy to prevent it from doing anything.
    #       The real action is called by cron '/root/docker/certbot/renew.sh'
    restart: "no"
    build: certbot
    command: /bin/true
    volumes:
      - letsencrypt:/etc/letsencrypt:nocopy
      - letsencrypt_www:/var/letsencrypt

  collectd:
    restart: unless-stopped
    build: collectd
    hostname: qnap-collectd
    depends_on:
      - influxdb
    volumes:
      - ./collectd/collectd.conf:/etc/collectd/collectd.conf:ro
      - collectd-data:/var/lib/collectd

  dovecot:
    restart: unless-stopped
    build: dovecot
    hostname: qnap-dovecot
    ports:
      - 993:993
    volumes:
      - letsencrypt:/usr/local/etc/letsencrypt:nocopy
      - vmail:/home/vmail:nocopy

# Note: 'network_mode: host' is required for the upnp server for multicast traffic
#       to detect the upnp server.
  gerbera-filme:
    restart: unless-stopped
    build: gerbera
    hostname: qnap-filme
    network_mode: host
    environment:
      - CONFIG=59158-filme
    volumes:
      - media_filme:/media:ro
      - gerbera-filme:/gerbera_home

  gerbera-fotos:
    restart: unless-stopped
    build: gerbera
    hostname: qnap-fotos
    network_mode: host
    environment:
      - CONFIG=59157-fotos
    volumes:
      - media_fotos:/media:ro
      - gerbera-fotos:/gerbera_home

  gerbera-kinder-filme:
    restart: unless-stopped
    build: gerbera
    hostname: qnap-kinder-filme
    network_mode: host
    environment:
      - CONFIG=59155-kinder-filme
    volumes:
      - media_kinder-filme:/media:ro
      - gerbera-kinder-filme:/gerbera_home

  gerbera-kinder-cds:
    restart: unless-stopped
    build: gerbera
    hostname: qnap-kinder-cds
    network_mode: host
    environment:
      - CONFIG=59156-kinder-cds
    volumes:
      - media_kinder-cds:/media:ro
      - gerbera-kinder-cds:/gerbera_home

  gerbera-musik:
    restart: unless-stopped
    build: gerbera
    hostname: qnap-gerbera-musik
    network_mode: host
    environment:
      - CONFIG=59154-musik
    volumes:
      - media_musik:/media:ro
      - gerbera-musik:/gerbera_home

  grafana:
    restart: unless-stopped
    image: grafana/grafana
    ports:
      - 53000:3000
    depends_on:
      - influxdb
    environment:
      GF_SERVER_ROOT_URL: http://192.168.6.7:53000
      GF_SECURITY_ADMIN_PASSWORD: 1234
    volumes:
      - grafana-storage:/var/lib/grafana

  influxdb:
    restart: unless-stopped
    image: influxdb
    # ports:
    #   - 8086:8086
    #   - 25826:25826/udp
    volumes:
      - influxdb:/var/lib/influxdb
      - ./influxdb/influxdb.conf:/etc/influxdb/influxdb.conf:ro
      - ./influxdb/types.db:/usr/share/collectd/types.db:ro

  js-dev:
    restart: "no"
    build: js-dev
    volumes:
      - jalousie_source:/source/jalousie

  mediawiki:
    build: mediawiki
    restart: unless-stopped
    depends_on:
      - mediawiki-database
      - mediawiki-parsoid
    volumes:
      - mediawiki-images:/var/www/html/images
      - ./mediawiki/LocalSettings.php:/var/www/html/LocalSettings.php

  mediawiki-database:
    image: yobasystems/alpine-mariadb:armhf
    restart: unless-stopped
    environment:
      # @see https://phabricator.wikimedia.org/source/mediawiki/browse/master/includes/DefaultSettings.php
      MYSQL_DATABASE: my_wiki
      MYSQL_USER: wikiuser
      MYSQL_PASSWORD: example
      MYSQL_RANDOM_ROOT_PASSWORD: "yes"
    volumes:
      - mediawiki-database:/var/lib/mysql

  mediawiki-database-backup:
    build: mediawiki-database-backup
    volumes:
      - mediawiki-database-backup:/backup
      - ./mediawiki-database-backup/automysqlbackup.conf:/etc/default/automysqlbackup
    depends_on:
      - mediawiki-database
      - postfix

  mediawiki-parsoid:
    build: mediawiki-parsoid
    restart: unless-stopped
    environment:
      PARSOID_DOMAIN_heine7: https://heine7.de/wiki/api.php
      PARSOID_HOME: /app/parsoid

  nginx:
    restart: unless-stopped
    build: nginx
    hostname: qnap-nginx
    ports:
      - 59080:80
      - 59443:443
    volumes:
      - letsencrypt:/etc/letsencrypt
      - letsencrypt_www:/var/letsencrypt
    depends_on:
      - apache2
      - mediawiki

  portainer:
    restart: unless-stopped
    image: portainer/portainer
    hostname: qnap-portainer
    ports:
      - 8008:9000
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer:/data

  postfix:
    restart: unless-stopped
    build: postfix
    hostname: qnap-postfix
    ports:
      - "25:25"
    volumes:
      - postfix_creds:/postfix_creds

  unison:
    restart: unless-stopped
    build: unison
    hostname: qnap-unison
    ports:
      - 1499:1499
    volumes:
      - media_musik:/var/musik:nocopy
      - sshd_certs:/var/sshd_certs:nocopy
      - unison:/root/.unison:nocopy
